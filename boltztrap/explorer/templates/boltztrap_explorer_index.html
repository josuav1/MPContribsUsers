{% extends "home/templates/base/header_footer.html" %}
{% load staticfiles %}

{% block title %} Transport Properties {% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href='{% static "components/bootstrap/dist/css/bootstrap.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/backgrid/lib/backgrid.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/backgrid-select-all/backgrid-select-all.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/backgrid-paginator/backgrid-paginator.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/backgrid-filter/backgrid-filter.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/backgrid-grouped-columns/backgrid-grouped-columns.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "components/json-human/css/json.human.css" %}' charset="utf-8">
<link href="//db.onlinewebfonts.com/c/1a6abbd133be395c851e058cbcb2a80a?family=Symbola" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

{% block content %}

{% if alert %}
<div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
  {{ alert }}
</div>

{% else %}

<style>
.backgrid { font-family: "symbola"; }
.backgrid tbody tr:hover { background-color: #f9f9f9; }
.backgrid .sortable { text-align: center; }
.backgrid thead th button { display: inline; }
.backgrid tbody tr { cursor: pointer; } 
.jh-root { font-family: "symbola"; }
.jh-type-string { font-style: normal; }
code { display: block; white-space: pre-wrap; }
.backgrid tbody tr td:nth-child(n+6):nth-child(-n+9) { background-color: #d0efc9; }
</style>

<div class="container">
    <a href="{% url 'mpcontribs_portal_index' %}">&laquo; Portal</a>

    <div class="row">
        <div class="col-md-8">
            <h2>{{ title }}</h2>
        </div>
        <div class="col-md-4">
            <div class="bg-danger" style="padding: 5px;">
                An example notebook to retrieve and interact with this data can be found
                <a target="_blank"
                   href="https://github.com/materialsproject/MPContribsUsers/blob/master/boltztrap/boltztrap.ipynb">here</a>.
               It's easiest to run it on the <a target="_blank" href="https://jupyterhub.materialsproject.org">MP JupyterHub</a> 
               (contact <a href="mailto:phuck@lbl.gov">Patrick Huck</a> to request access).
            </div>
        </div>
    </div>

    <div class="row">
        {{ provenance|safe }}
    </div>

    <div class="row">
        <div class="col-md-6">
            <div id="graph" style="width: 100%;"></div>
            <div id="spinner" ></div>
        </div>
        <div class="col-md-6">
            <div id="graph2" style="width: 100%;"></div>
        </div>
    </div>

    <div class="row" style="margin-top: 10px;">
        <div class="col-md-7">
            <h3>average eigenvalues @ 300 K & 10¹⁸ cm⁻³</h3>
        </div>
        <div class="col-md-5">
            <div class="bg-success" style="padding: 5px;">
                Click a green cell to update the temperature and
                doping level dependence above, and display the
                according eigenvalues.
            </div>
        </div>
    </div>

    <div class="row">
        {{ table|safe }}
    </div>

</div>

<script>
requirejs(['config'], function() {
    require(["plotly", "jquery.spin"], function(Plotly) {
        $("#spinner").spin('small');

        $.ajax({
            type: 'GET',
            url: 'rest',
            contentType: "application/json; charset=utf-8",
            success: function(data, textStatus, jqXHR) {
                var r = data['response'];
                if ( 'null' != r ) {
                    var graph = document.getElementById('graph');
                    Plotly.newPlot(graph, [{
                        x: r['<σ>'], y: r['<S>'], mode: 'markers', text: r['text'],
                        type: 'scattergl', marker: {
                            color: r['<S²σ>'], colorscale: 'Viridis',
                            colorbar: {title: 'log(PF)'}
                        }
                    }], {
                        xaxis: {title: 'σ [(Ωms)⁻¹]', exponentformat: "power", type: 'log'},
                        yaxis: {title: 'S [μV/K]'},
                        margin: {l: 60, b: 50, t: 20}
                    });
                    window.onresize = function() {
                        Plotly.Plots.resize(graph);
                    };
                }
                $('#spinner').spin(false);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            }
        });

        $(document).ready(function(){

            Backbone.on('cellclicked', function(e) {
                var row = $(e.currentTarget).parent();
                var url = row.find("td:nth-child(2) > a").attr('href');
                var cid = url.split('/').pop();
                var classes = $(e.currentTarget).attr("class").split(' ');
                var payload = JSON.stringify({name: classes[3] + ' ' + classes[4]});
                $.ajax({
                    type: 'POST',
                    url: 'rest/' + cid,
                    data: payload,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function(data, textStatus, jqXHR) {
                        if ( 'null' != data['response'] ) {
                            var eigs = data['response']['eigs'];
                            var annot = '<b>ε₁ = '+eigs[0]+'<br>ε₂ = '+eigs[1]+'<br>ε₃ = '+eigs[2]+'</b>';
                            var div = document.getElementById('graph2');
                            Plotly.newPlot(div, [data['response']], {
                                showLegend: false, margin: {l: 50, r: 0, b: 50, t: 20},
                                xaxis: {type: 'log', title: 'doping level [cm⁻³]', exponentformat: "power"},
                                yaxis: {title: 'temperature [K]'},
                                annotations: [{
                                    xref: 'paper', yref: 'paper', x: 1.03, xanchor: 'left',
                                    y: 0, yanchor: 'top', text: annot, showarrow: false
                                }]
                            });
                            window.onresize = function() {
                                Plotly.Plots.resize(div);
                            };
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(errorThrown);
                    }
                });
            }); 

            $(".backgrid > tbody > tr:first > td:nth-child(6)").click()

        });
    });
});
</script>

{% endif %}
{% endblock %}
